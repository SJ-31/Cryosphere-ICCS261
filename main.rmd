```{r}
source("./all_artifacts.r")
```
### Phylogenetic trees
```{r}
fasttree <- get_artifact_data(
    "./results/6-RootedTrees", id_key,
    "FastTree_RootedTree"
)
iqtree <- get_artifact_data(
    "./results/6-RootedTrees", id_key,
    "IQTREE_RootedTree"
)
```

### Taxonomic classifications
```{r}
blast <- lapply(
    get_artifact_data("./results/3-Classified", id_key, "BLAST_All"),
    parse_taxonomy
)
# sklearn <- lapply(
#     get_artifact_data("./results/3-Classified", id_key, "Sklearn"),
#     parse_taxonomy
# )
```
TODO: Which classifier was better?

The `known_taxon` function collapses the taxonomy table into the first identification. A similar function will be used to collapse it into at least genus identifications for use with farprotax.

### Import frequency tables
The frequency tables are stored in BIOM format: OTUs x sites
```{r}
otu_freqs <- lapply(
    get_artifact_data("./results/2-OTUs", id_key, "otuFreqs"),
    as.data.frame
)
```

The following snippet maps otu ids the genus-level identifications for use with the farprotax database, writing csv files for each.
```{r}
otu_genus <- list()
for (id in names(id_key)) {
    otu_genus[[id]] <- to_genus_csv(otu_freqs[[id]], blast[[id]])
}
combined <- bind_rows(otu_genus) %>%
    arrange(taxon) %>%
    group_by(taxon) %>%
    summarise(across(everything(), sum))
combined[is.na(combined)] <- 0.0
write.csv(combined, "genus_otu_tables.csv", row.names = FALSE)
```

## Importing PCOA artifacts

```{r}
```

## Beta diversity
```{r}
beta <- get_artifact_data("./results/7-Diversity",
    list(Merged = NULL),
    extension = "",
    metric_list = beta_metrics
)
pcoa2D <- get_artifact_data("./results/8-Analysis",
    list(Merged = NULL),
    extension = "PCOA-2D_",
    metric_list = beta_metrics
)
pcoa2D_merged <- lapply(pcoa2D$Merged, metadata_merge_pcoa, metadata = metadata)
```
