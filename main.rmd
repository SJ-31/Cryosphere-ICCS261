```{r}
source("./all_artifacts.r")
```

### Taxonomic classifications
```{r}
blast <- lapply(
    get_artifact_data("./results/3-Classified", id_key, "BLAST_All"),
    parse_taxonomy
)
sklearn <- lapply(
    get_artifact_data("./results/3-Classified", id_key, "Sklearn"),
    parse_taxonomy
)
sk_merged <- read_qza("./results/3-Classified/Merged-Sklearn.qza")$data %>%
    parse_taxonomy()
```
Simply by counting the number of NA entries in the taxonomy columns, the sklearn
classifier consistently outperforms the traditional blast approach. Furthermore, the sklearn is faster and consumes less memory (aside from the initial training step, which I could not do)

The `known_taxon` function collapses the taxonomy table into the first identification. A similar function will be used to collapse it into at least genus identifications for use with farprotax.

### Phylogenetic trees
```{r}
fasttree <- get_artifact_data(
    "./results/6-RootedTrees", id_key,
    "FastTree_RootedTree"
)
iqtree <- get_artifact_data(
    "./results/6-RootedTrees", id_key,
    "IQTREE_RootedTree"
)
```



### Import frequency tables
The frequency tables are stored in BIOM format: OTUs x sites
```{r}
otu_freqs <- lapply(
    get_artifact_data("./results/2-OTUs", id_key, "otuFreqs"),
    as.data.frame
)
```

The following snippet maps otu ids the genus-level identifications for use with the farprotax database, writing csv files for each.
```r
otu_genus <- list()
for (id in names(id_key)) {
    otu_genus[[id]] <- to_genus_csv(otu_freqs[[id]], blast[[id]])
}
genus_combined <- combine_freqs(otu_genus, taxon)
# write.csv(combined, "genus_otu_tables.csv", row.names = FALSE)
```

## Diversity analyses

### Alpha diversity


### Beta diversity
All ordination plots will be carried out with PCOA
```{r}
beta <- get_artifact_data("./results/7-Diversity",
    list(Merged = NULL),
    extension = "",
    metric_list = beta_metrics
)
pcoa2D <- get_artifact_data("./results/8-Analysis",
    list(Merged = NULL),
    extension = "PCOA-2D_",
    metric_list = beta_metrics
)
pcoa2D_merged <- lapply(pcoa2D$Merged, metadata_merge_pcoa, metadata = metadata)
pcoaja <- plot_pcoa(pcoa2D_merged$ja, "Location",
    title = "Jaccard distance"
)
pcoabc <- plot_pcoa(pcoa2D_merged$bc, "Location",
    title = "Bray Curtis"
)
pcoauu <- plot_pcoa(pcoa2D_merged$uu, "Location",
    title = "Unweighted Unifrac",
)
pcoawn <- plot_pcoa(pcoa2D_merged$wn, "Location",
    title = "Weighted Normalized Unifrac ",
)
pcoa_arrange <- ggarrange(pcoabc, pcoauu, pcoawn,
    ncol = 3,
    common.legend = TRUE,
    legend = "right"
)
ggsave("./figures/pcoas.png",
    plot = pcoa_arrange,
    dpi = "retina", width = 20, height = 10
)
```
The pcoa plots depict clearly how the choice of distance metric affects the clustering of samples. Clustering in the Bray Curtis plot represents sites sharing many of the same species and in similar abundances. The big cluster falls apart   

It's interesting how the Villum station site is 
We rule out the soil site, 
After visualizing the beta diversity, we can immediately rule
In all plots, we can see that there is a high degree of variation within samples belonging to the same site.  
From the plot, we can see that the Bray Curtis, distance metric, without taking into account phylogenetic distances doesn't separate most of the sites too well.Strangely though, the soil "outgroup" in the BC plot cannot be distinguished from the others 

PERMANOVA
```{r}
adonis2(beta$Merged$bc ~ metadata$Location)
```

### Functional analysis
The raw output tables here are the absolute abundances of molecular functions in each site using the KEGG Orthology database (KO). PICRUSt2 integrates with other databases, such as Enzyme Commission numbers (EC), but I've chosen to use the KO database because the PICRUSt2 authors describe how they've improved on the database integration compared to PICRUSt1.
As PICRUSt2 failed to analyze the merged dataset, I will combine the output tables from each sample.
```{r}
ko_all <- ko %>%
    # Merge the PICRUSt2 tables
    reduce(merge, by = "function", all = TRUE) %>%
    as_tibble() %>%
    replace(is.na(.), 0) %>%
    rel_abund() %>% # Convert to relative abundances
    as_tibble() %>%
    sites_x_func() # Transpose into sites x function format

# Compute bray curtis distance, then plot pcoa
bc_func <- vegdist(ko_all, method = "bray")
pcoa_bc_func <- bc_func %>%
    wcmdscale(k = 2) %>%
    metadata_merge_pcoa(metadata, ., functions = TRUE)
# Compute jaccard distance
ja_func <- vegdist(ko_all, method = "jaccard")
pcoa_ja_func <- ja_func %>%
    wcmdscale(k = 2) %>%
    metadata_merge_pcoa(metadata, ., functions = TRUE)

# Plot and compare with ordination on taxonomy
plot_ja_func <- plot_pcoa(pcoa_ja_func, "Location",
    title = "Jaccard distance",
    subtitle = "From biological functions", functions = TRUE
)
plot_bc_func <- plot_pcoa(pcoa_bc_func, "Location",
    title = "Bray Curtis",
    subtitle = "From biological functions", functions = TRUE
)
func_compare <- ggarrange(plot_ja_func, pcoaja, plot_bc_func, pcoabc,
    ncol = 2, nrow = 2, common.legend = TRUE, legend = "bottom"
)
ggsave("./figures/func_vs_tax.png",
    plot = func_compare,
    dpi = "retina", width = 20, height = 10
)
```


### Differential abundance analysis
First, we will perform tests on the abundance of identified OTUs.

```bash
# One of the assumptions that ANCOM-BC makes is that fewer than 25% of OTUs are changing between groups, so we as with ANOSIM and PERMANOVA, we keep only the sites that appear close together through beta diversity
qiime feature-table filter-samples \
--i-table  \
--m-metadata-file ds_metadata.tsv \
--p-where '[Location]='"'"'gut'"'"'' \
--o-filtered-table

# Collapse into the taxonomy into order-level identifications
qiime taxa collapse \
--i-table \
--i-taxonomy \
--p-level 4 \
--o-collapsed-table

# ANCOM-BC cannot deal with zeros, so we need to perform a pseudocount
qiime composition add-pseudocount \
--i-table ./results/2-OTUs/Merged-otuFreqs.qza \
--o-composition-table .results/8-Analysis/ANCOM-BC/Merged-composition.qza

qiime composition ancombc \
--i-table ./results/8-Analysis/ANCOM-BC/Merged-composition.qza \
--m-metadata-file ds_metadata.tsv \
--p-formula Location \
--o-differentials ./results/8-Analysis/
```

```{r}
known_otus <- list()
for (id in names(id_key)) {
    known_otus[[id]] <- merge_with_id(otu_freqs[[id]], sklearn[[id]])
}
# combined <- combine_freqs(known_otus, taxon) %>%
#     inner_join(metadata, )
# Import all ancombc results
ancombc_path <- "./results/8-Analysis/ancombc"
ancombc_lfc <- read_csv("./results/8-Analysis/ancombc/w_slice.csv") # Log-fold change divided by standard error
ancombc_q_val <- read_csv("./results/8-Analysis/ancombc/w_slice.csv")
```

ANCOM-BC will be conducted for each site to determine which taxa are differentially abundant. The results will then
- ANCOM-BC returns five metrics for each OTU:
    - Log fold change across different sites
    - W-score: log fold change across different sites divided by standard error
    - p value
    - q value
    - Standard error
